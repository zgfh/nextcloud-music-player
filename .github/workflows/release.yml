name: Auto Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.2.3 ç­‰æ ¼å¼çš„æ ‡ç­¾

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´çš„gitåŽ†å²
    
    - name: Extract version from tag
      id: version
      run: |
        # ä»Žæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰vå‰ç¼€ï¼‰
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          # ç”Ÿæˆä»Žä¸Šä¸€ä¸ªæ ‡ç­¾åˆ°å½“å‰æ ‡ç­¾çš„æ›´æ”¹æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD)
        else
          # å¦‚æžœæ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œç”Ÿæˆä»Žç¬¬ä¸€ä¸ªæäº¤åˆ°å½“å‰çš„æ›´æ”¹æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s")
        fi
        
        # å¦‚æžœæ›´æ”¹æ—¥å¿—ä¸ºç©ºï¼Œæä¾›é»˜è®¤ä¿¡æ¯
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="- Initial release"
        fi
        
        # ä¿å­˜åˆ°æ–‡ä»¶ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
        echo "$CHANGELOG" > changelog.txt
        
        # åˆ›å»ºå®Œæ•´çš„å‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << 'EOF'
        ## ðŸŽµ NextCloud Music Player v${{ steps.version.outputs.version }}
        
        æ„Ÿè°¢ä½¿ç”¨ NextCloud Music Playerï¼è¿™æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒä¸Ž NextCloud æœåŠ¡å™¨åŒæ­¥éŸ³ä¹æ–‡ä»¶ã€‚
        
        ### ðŸ“¦ ä¸‹è½½
        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
        
        #### æ¡Œé¢å¹³å°
        - **Windows**: `.msi` æ–‡ä»¶ - é€‚ç”¨äºŽ Windows 10/11
        - **macOS**: `.dmg` æ–‡ä»¶ - é€‚ç”¨äºŽ macOS 10.14+
        - **Linux**: `.deb` æ–‡ä»¶ - é€‚ç”¨äºŽ Ubuntu/Debian ç³»ç»Ÿ
        
        #### ç§»åŠ¨å¹³å°
        - **iOS**: Xcode é¡¹ç›®æ–‡ä»¶ - éœ€è¦è‡ªè¡Œç¼–è¯‘å’Œç­¾å
        - **Android**: `.apk` æ–‡ä»¶ï¼ˆå¦‚æžœå¯ç”¨ï¼‰- é€‚ç”¨äºŽ Android 7.0+
        
        **æ³¨æ„**: ç§»åŠ¨å¹³å°ç‰ˆæœ¬å¯èƒ½éœ€è¦é¢å¤–çš„é…ç½®æ­¥éª¤ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£èŽ·å–è¯¦ç»†è¯´æ˜Žã€‚
        
        ### âœ¨ æœ¬ç‰ˆæœ¬æ›´æ–°
        EOF
        
        cat changelog.txt >> release_notes.md
        
        cat >> release_notes.md << 'EOF'
        
        ### ðŸš€ ä¸»è¦åŠŸèƒ½
        - ðŸŽµ æ”¯æŒMP3éŸ³ä¹æ’­æ”¾
        - â˜ï¸ NextCloudæœåŠ¡å™¨é›†æˆ
        - ðŸ“± è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxã€iOSã€Androidï¼‰
        - ðŸŽ›ï¸ å®Œæ•´çš„æ’­æ”¾æŽ§åˆ¶ï¼ˆæ’­æ”¾ã€æš‚åœã€ä¸Šä¸€é¦–ã€ä¸‹ä¸€é¦–ï¼‰
        - ðŸ“Š æ’­æ”¾è¿›åº¦æ¡å’ŒéŸ³é‡æŽ§åˆ¶
        - ðŸ”„ æ’­æ”¾æ¨¡å¼åˆ‡æ¢ï¼ˆé¡ºåºã€éšæœºã€å¾ªçŽ¯ï¼‰
        - ðŸ’¾ ç¦»çº¿ç¼“å­˜æ”¯æŒ
        - ðŸ“‚ æ–‡ä»¶å¤¹é€‰æ‹©åŒæ­¥
        
        ### ðŸ“± ç§»åŠ¨å¹³å°è¯´æ˜Ž
        
        #### iOS å®‰è£…
        1. ä¸‹è½½ iOS æž„å»ºæ–‡ä»¶
        2. ä½¿ç”¨ Xcode æ‰“å¼€é¡¹ç›®
        3. é…ç½®å¼€å‘è€…è¯ä¹¦
        4. ç¼–è¯‘å¹¶å®‰è£…åˆ°è®¾å¤‡
        
        #### Android å®‰è£…
        1. ä¸‹è½½ `.apk` æ–‡ä»¶ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
        3. å®‰è£… APK æ–‡ä»¶
        4. æˆ–è€…ä¸‹è½½æºç è‡ªè¡Œç¼–è¯‘
        
        ### ðŸ› é—®é¢˜åé¦ˆ
        å¦‚æžœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/zgfh/nextcloud-music-player/issues) ä¸­åé¦ˆã€‚
        
        ### ðŸ“ å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
        2. æŒ‰ç…§ç³»ç»Ÿæç¤ºå®‰è£…åº”ç”¨
        3. å¯åŠ¨åº”ç”¨å¹¶é…ç½®æ‚¨çš„ NextCloud æœåŠ¡å™¨è¿žæŽ¥
        4. äº«å—éŸ³ä¹æ’­æ”¾ä½“éªŒï¼
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: NextCloud Music Player v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}
