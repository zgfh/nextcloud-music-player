name: Test Android Build Fix

on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/**'
      - 'pyproject.toml'

jobs:
  test-android-deps:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Check Ubuntu version and packages
      run: |
        echo "=== Ubuntu Version ==="
        lsb_release -a
        echo "=== Available Cairo packages ==="
        apt-cache search libcairo2-dev
        echo "=== Available pkg-config ==="
        apt-cache search pkg-config

    - name: Install system dependencies for pycairo
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          build-essential \
          libcairo2-dev \
          libpango1.0-dev \
          libglib2.0-dev \
          libgdk-pixbuf2.0-dev \
          libffi-dev \
          libgirepository1.0-dev \
          libcairo-gobject2 \
          libgirepository-1.0-1 \
          libgtk-3-0 \
          libpango-1.0-0

    - name: Verify Cairo installation
      run: |
        echo "=== Checking pkg-config packages ==="
        pkg-config --list-all | grep -E "(cairo|pango|glib)" || true
        echo "=== Checking specific packages ==="
        pkg-config --exists cairo && echo "✓ cairo" || echo "✗ cairo"
        pkg-config --exists pango && echo "✓ pango" || echo "✗ pango"
        pkg-config --exists glib-2.0 && echo "✓ glib-2.0" || echo "✗ glib-2.0"
        pkg-config --exists gobject-introspection-1.0 && echo "✓ gobject-introspection" || echo "✗ gobject-introspection"
        
        echo "=== Cairo version ==="
        pkg-config --modversion cairo || echo "No cairo version found"
        
        echo "=== Cairo cflags ==="
        pkg-config --cflags cairo || echo "No cairo cflags found"
        
        echo "=== Cairo libs ==="
        pkg-config --libs cairo || echo "No cairo libs found"

    - name: Setup Android SDK (minimal)
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.0
        
    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Test pycairo installation directly
      run: |
        echo "=== Testing pycairo installation ==="
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install pycairo --verbose || {
          echo "=== pycairo installation failed, showing environment ==="
          echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
          pkg-config --debug cairo 2>&1 || true
          exit 1
        }
        
        echo "=== Testing pycairo import ==="
        python -c "import cairo; print(f'pycairo version: {cairo.version}')"

    - name: Install Python dependencies
      run: |
        pip install briefcase
        pip install toga>=0.4.0 requests>=2.25.0 httpx>=0.24.0

    - name: Test briefcase create android
      run: |
        echo "=== Testing briefcase create android ==="
        python -m briefcase create android || {
          echo "=== Briefcase create failed, checking logs ==="
          find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \;
          exit 1
        }
        
        echo "=== Android project created successfully! ==="
        ls -la android/ || echo "No android directory found"
