name: Mobile Build

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/mobile.yml'
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install system dependencies
      run: |
        # å®‰è£… iOS å¼€å‘æ‰€éœ€çš„å·¥å…·
        brew install libffi
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase
        pip install toga>=0.4.0 requests>=2.25.0 httpx>=0.24.0
    
    - name: Create iOS app structure
      run: |
        python -m briefcase create iOS
    
    - name: Build iOS app
      run: |
        python -m briefcase build iOS
      continue-on-error: true
    
    - name: Archive iOS build output
      run: |
        # åˆ›å»ºæž„å»ºè¾“å‡ºå½’æ¡£
        if [ -d "iOS" ]; then
          tar -czf ios-build-output.tar.gz iOS/
        fi
        
        # æ”¶é›†æž„å»ºæ—¥å¿—
        if [ -d "build" ]; then
          tar -czf ios-build-logs.tar.gz build/
        fi
    
    - name: Upload iOS artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ios-build-${{ github.sha }}
        path: |
          ios-build-output.tar.gz
          ios-build-logs.tar.gz
        retention-days: 30

  build-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.0
        cmake: 3.22.1
        ndk: 25.1.8937393
        
    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase
        pip install toga>=0.4.0 requests>=2.25.0 httpx>=0.24.0
    
    - name: Create Android app structure
      run: |
        python -m briefcase create android
    
    - name: Build Android app
      run: |
        python -m briefcase build android
      continue-on-error: true
    
    - name: Package Android app
      run: |
        python -m briefcase package android
      continue-on-error: true
    
    - name: Archive Android build output
      run: |
        # åˆ›å»ºæž„å»ºè¾“å‡ºå½’æ¡£
        if [ -d "android" ]; then
          tar -czf android-build-output.tar.gz android/
        fi
        
        # æ”¶é›†APKæ–‡ä»¶
        if [ -d "dist" ]; then
          cp dist/*.apk . 2>/dev/null || true
        fi
        
        # æ”¶é›†æž„å»ºæ—¥å¿—
        if [ -d "build" ]; then
          tar -czf android-build-logs.tar.gz build/
        fi
    
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v3
      with:
        name: android-build-${{ github.sha }}
        path: |
          android-build-output.tar.gz
          android-build-logs.tar.gz
          *.apk
        retention-days: 30

  create-mobile-summary:
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Create build summary
      run: |
        echo "# ðŸ“± Mobile Build Summary" > mobile-summary.md
        echo "" >> mobile-summary.md
        echo "Build completed for commit: ${{ github.sha }}" >> mobile-summary.md
        echo "Date: $(date)" >> mobile-summary.md
        echo "" >> mobile-summary.md
        
        echo "## ðŸ“Š Build Status" >> mobile-summary.md
        echo "" >> mobile-summary.md
        
        # iOS æž„å»ºçŠ¶æ€
        if [ -d "ios-build-${{ github.sha }}" ]; then
          echo "- âœ… iOS: Build completed" >> mobile-summary.md
          if [ -f "ios-build-${{ github.sha }}/ios-build-output.tar.gz" ]; then
            echo "  - ðŸ“¦ Project files available" >> mobile-summary.md
          fi
        else
          echo "- âŒ iOS: Build failed" >> mobile-summary.md
        fi
        
        # Android æž„å»ºçŠ¶æ€
        if [ -d "android-build-${{ github.sha }}" ]; then
          echo "- âœ… Android: Build completed" >> mobile-summary.md
          if ls android-build-${{ github.sha }}/*.apk 1> /dev/null 2>&1; then
            echo "  - ðŸ“¦ APK files available" >> mobile-summary.md
          else
            echo "  - ðŸ“ Project files available (APK generation may have failed)" >> mobile-summary.md
          fi
        else
          echo "- âŒ Android: Build failed" >> mobile-summary.md
        fi
        
        echo "" >> mobile-summary.md
        echo "## ðŸ“ Notes" >> mobile-summary.md
        echo "" >> mobile-summary.md
        echo "- iOS builds require Xcode and Apple Developer account for device installation" >> mobile-summary.md
        echo "- Android APKs are unsigned and for development/testing purposes only" >> mobile-summary.md
        echo "- For production releases, proper signing and store submission processes are required" >> mobile-summary.md
        
        cat mobile-summary.md
    
    - name: Upload summary
      uses: actions/upload-artifact@v3
      with:
        name: mobile-build-summary
        path: mobile-summary.md
