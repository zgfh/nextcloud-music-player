name: Mobile Build

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/mobile.yml'
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install system dependencies
      run: |
        # 安装 iOS 开发所需的工具
        brew install libffi
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase
        pip install toga>=0.4.0 requests>=2.25.0 httpx>=0.24.0
    
    - name: Create iOS app structure
      run: |
        python -m briefcase create iOS
    
    - name: Build iOS app
      run: |
        python -m briefcase build iOS
      continue-on-error: true
    
    - name: Archive iOS build output
      run: |
        # 创建构建输出归档
        if [ -d "iOS" ]; then
          tar -czf ios-build-output.tar.gz iOS/
        fi
        
        # 收集构建日志
        if [ -d "build" ]; then
          tar -czf ios-build-logs.tar.gz build/
        fi
    
    - name: Upload iOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.sha }}
        path: |
          ios-build-output.tar.gz
          ios-build-logs.tar.gz
        retention-days: 30

  build-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Install system dependencies for pycairo
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          build-essential \
          libcairo2-dev \
          libpango1.0-dev \
          libglib2.0-dev \
          libgdk-pixbuf2.0-dev \
          libffi-dev \
          libgirepository1.0-dev \
          libcairo-gobject2 \
          libgirepository-1.0-1 \
          libgtk-3-0 \
          libpango-1.0-0
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 33
        build-tools: 33.0.0
        cmake: 3.22.1
        ndk: 25.1.8937393
        
    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase
        pip install toga>=0.4.0 requests>=2.25.0 httpx>=0.24.0
    
    - name: Create Android app structure
      run: |
        python -m briefcase create android
    
    - name: Build Android app
      run: |
        python -m briefcase build android
      continue-on-error: true
    
    - name: Package Android app
      run: |
        python -m briefcase package android
      continue-on-error: true
    
    - name: Archive Android build output
      run: |
        # 创建构建输出归档
        if [ -d "android" ]; then
          tar -czf android-build-output.tar.gz android/
        fi
        
        # 收集APK文件
        if [ -d "dist" ]; then
          cp dist/*.apk . 2>/dev/null || true
        fi
        
        # 收集构建日志
        if [ -d "build" ]; then
          tar -czf android-build-logs.tar.gz build/
        fi
    
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-build-${{ github.sha }}
        path: |
          android-build-output.tar.gz
          android-build-logs.tar.gz
          *.apk
        retention-days: 30

  create-mobile-summary:
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create build summary
      run: |
        echo "# 📱 Mobile Build Summary" > mobile-summary.md
        echo "" >> mobile-summary.md
        echo "Build completed for commit: ${{ github.sha }}" >> mobile-summary.md
        echo "Date: $(date)" >> mobile-summary.md
        echo "" >> mobile-summary.md
        
        echo "## 📊 Build Status" >> mobile-summary.md
        echo "" >> mobile-summary.md
        
        # iOS 构建状态
        if [ -d "artifacts/ios-build-${{ github.sha }}" ]; then
          echo "- ✅ iOS: Build completed" >> mobile-summary.md
          if [ -f "artifacts/ios-build-${{ github.sha }}/ios-build-output.tar.gz" ]; then
            echo "  - 📦 Project files available" >> mobile-summary.md
          fi
        else
          echo "- ❌ iOS: Build failed" >> mobile-summary.md
        fi
        
        # Android 构建状态
        if [ -d "artifacts/android-build-${{ github.sha }}" ]; then
          echo "- ✅ Android: Build completed" >> mobile-summary.md
          if ls artifacts/android-build-${{ github.sha }}/*.apk 1> /dev/null 2>&1; then
            echo "  - 📦 APK files available" >> mobile-summary.md
          else
            echo "  - 📁 Project files available (APK generation may have failed)" >> mobile-summary.md
          fi
        else
          echo "- ❌ Android: Build failed" >> mobile-summary.md
        fi
        
        echo "" >> mobile-summary.md
        echo "## 📝 Notes" >> mobile-summary.md
        echo "" >> mobile-summary.md
        echo "- iOS builds require Xcode and Apple Developer account for device installation" >> mobile-summary.md
        echo "- Android APKs are unsigned and for development/testing purposes only" >> mobile-summary.md
        echo "- For production releases, proper signing and store submission processes are required" >> mobile-summary.md
        
        cat mobile-summary.md
    
    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: mobile-build-summary
        path: mobile-summary.md
